<!DOCTYPE html>
<html>
<head>
    <title>Messenger Pro</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1e1f22; color: #dbdee1; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar Styles */
        .sidebar { width: 260px; background: #2b2d31; display: flex; flex-direction: column; border-right: 1px solid #1e1f22; }
        .sidebar-header { padding: 20px; background: #232428; border-bottom: 1px solid #1e1f22; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        .section-title { font-size: 0.7rem; font-weight: bold; color: #949ba4; text-transform: uppercase; margin: 15px 0 5px 5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* List Items */
        .nav-item { padding: 8px 12px; border-radius: 4px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; transition: 0.2s; font-size: 0.9rem; }
        .nav-item:hover { background: #35373c; color: white; }
        .nav-item.active { background: #404249; color: white; }
        .nav-item.global { color: #5865f2; font-weight: bold; }
        .delete-btn { opacity: 0; color: #da373c; font-size: 0.8rem; padding: 0 5px; }
        .nav-item:hover .delete-btn { opacity: 1; }

        /* Main Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .room-info { background: #313338; padding: 15px 20px; font-size: 1rem; font-weight: bold; border-bottom: 1px solid #1e1f22; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #313338; }
        .msg { background: #383a40; padding: 10px 15px; border-radius: 8px; max-width: 80%; align-self: flex-start; }
        .msg.mine { align-self: flex-end; background: #5865f2; color: white; }
        .msg b { display: block; font-size: 0.75rem; color: #00aff4; margin-bottom: 3px; }
        .msg.mine b { color: #e0e0e0; }
        .time { font-size: 0.65rem; opacity: 0.6; margin-top: 5px; text-align: right; display: block; }

        /* Inputs */
        .input-area { padding: 20px; background: #313338; display: flex; gap: 10px; }
        input.chat-input { flex: 1; background: #383a40; border: none; padding: 12px; color: white; border-radius: 5px; outline: none; }
        button.send-btn { background: #5865f2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .add-btn { cursor: pointer; font-size: 1.2rem; line-height: 1; }
        .settings-icon { cursor: pointer; opacity: 0.7; font-size: 1.2rem; }
        .settings-icon:hover { opacity: 1; }

        /* Modals & Auth Screens */
        #auth-container, #custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; color: white; }
        .auth-box, .modal-box { background: #2b2d31; padding: 40px; border-radius: 8px; width: 350px; text-align: center; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 4px; border: none; background: #1e1f22; color: white; box-sizing: border-box; outline: none; }
        .auth-btn { width: 100%; padding: 12px; margin-top: 20px; background: #5865f2; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: transparent; color: white; border: none; cursor: pointer; padding: 10px; }
        .btn-confirm { background: #5865f2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="custom-modal">
    <div class="modal-box">
        <h2 id="modal-title" style="margin-top:0;">Action</h2>
        <p id="modal-desc" style="color: #b5bac1; font-size: 0.9rem;"></p>
        <input type="text" id="modal-input" class="auth-input" placeholder="">
        <div class="modal-buttons" id="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="btn-confirm" id="modal-confirm-btn">Confirm</button>
        </div>
    </div>
</div>

<div id="auth-container">
    <div class="auth-box">
        <h2 id="auth-title">Welcome Back</h2>
        <input type="text" id="auth-username" class="auth-input" placeholder="Username">
        <input type="password" id="auth-password" class="auth-input" placeholder="Password">
        <button onclick="handleAuthAction()" id="auth-submit-btn" class="auth-btn">Log In</button>
        <p id="auth-switch-text" style="margin-top: 20px; font-size: 0.85rem; color: #b5bac1;">
            Need an account? <a href="#" onclick="toggleAuthMode()" style="color: #00a8fc; text-decoration: none;">Register</a>
        </p>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header">
        <div>
            <h3 style="margin: 0; font-size: 1.1rem; color: white;">Messenger Pro</h3>
            <span style="font-size: 0.8rem; color: #b5bac1;"><b id="user-display">...</b></span>
        </div>
        <span class="settings-icon" onclick="logoutRequest()" title="Logout">‚öôÔ∏è</span>
    </div>

    <div class="sidebar-content">
        <div class="nav-item global" id="item-Global" onclick="switchRoom('Global')"># Global Chat</div>
        <div class="section-title">Servers <span class="add-btn" onclick="addRoom('server')">+</span></div>
        <div id="server-list"></div>
        <div class="section-title">Private Chats <span class="add-btn" onclick="addRoom('friend')">+</span></div>
        <div id="friend-list"></div>
    </div>
</div>

<div class="chat-area">
    <div class="room-info">
        <span># <span id="room-display">Global</span></span>
    </div>
    <div id="messages"></div>
    <div class="input-area">
        <input type="text" id="message-input" class="chat-input" placeholder="Message..." onkeypress="handleKey(event)">
        <button class="send-btn" onclick="sendMessage()">Send</button>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBDAjMzBQs9KAqGbTnJbXFc3L9tRcAwKGA",
    authDomain: "messenger-app-4a96f.firebaseapp.com",
    projectId: "messenger-app-4a96f",
    storageBucket: "messenger-app-4a96f.firebasestorage.app",
    messagingSenderId: "225256050732",
    appId: "1:225256050732:web:26d94b7c8022229ec94189"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentRoom = localStorage.getItem('chat_room') || "Global";
  let servers = JSON.parse(localStorage.getItem('chat_servers')) || [];
  let friends = JSON.parse(localStorage.getItem('chat_friends')) || [];
  let isSignupMode = false;
  let unsubscribeMessages = null;

  // --- MODAL SYSTEM ---
  window.closeModal = () => { document.getElementById('custom-modal').style.display = 'none'; };
  
  function openModal(title, desc, inputPlaceholder, confirmText, onConfirm, showInput = true) {
    const modal = document.getElementById('custom-modal');
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-desc').innerText = desc;
    const input = document.getElementById('modal-input');
    input.style.display = showInput ? 'block' : 'none';
    input.placeholder = inputPlaceholder;
    input.value = "";
    
    const confirmBtn = document.getElementById('modal-confirm-btn');
    confirmBtn.innerText = confirmText;
    confirmBtn.onclick = () => { onConfirm(input.value); };
    modal.style.display = 'flex';
  }

  // --- AUTH LOGIC ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('user-display').innerText = user.displayName || user.email.split('@')[0];
      checkInvites();
      initChat();
      renderSidebar();
    } else {
      document.getElementById('auth-container').style.display = 'flex';
    }
  });

  window.toggleAuthMode = () => {
    isSignupMode = !isSignupMode;
    document.getElementById('auth-title').innerText = isSignupMode ? "Create Account" : "Welcome Back";
    document.getElementById('auth-submit-btn').innerText = isSignupMode ? "Register" : "Log In";
  };

  window.handleAuthAction = async () => {
    const user = document.getElementById('auth-username').value.trim();
    const pass = document.getElementById('auth-password').value;
    const ghostEmail = `${user.toLowerCase()}@messenger.internal`;
    try {
      if (isSignupMode) {
        const cred = await createUserWithEmailAndPassword(auth, ghostEmail, pass);
        await updateProfile(cred.user, { displayName: user });
      } else {
        await signInWithEmailAndPassword(auth, ghostEmail, pass);
      }
    } catch (e) { alert(e.message); }
  };

  window.logoutRequest = () => {
    openModal("Logout", "Are you sure you want to log out?", "", "Logout", () => {
        signOut(auth).then(() => { localStorage.clear(); location.reload(); });
    }, false);
  };

  // --- CHAT LOGIC ---
  function initChat() {
    if (unsubscribeMessages) unsubscribeMessages();
    const q = query(collection(db, "messages"), where("room", "==", currentRoom), orderBy("timestamp", "asc"));
    unsubscribeMessages = onSnapshot(q, (snapshot) => {
      const msgBox = document.getElementById('messages');
      msgBox.innerHTML = "";
      snapshot.forEach((doc) => {
        const data = doc.data();
        let time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "...";
        const div = document.createElement('div');
        div.className = `msg ${data.user === auth.currentUser.displayName ? 'mine' : ''}`;
        div.innerHTML = `<b>${data.user}</b>${data.text}<span class="time">${time}</span>`;
        msgBox.appendChild(div);
      });
      msgBox.scrollTop = msgBox.scrollHeight;
    });
  }

  window.sendMessage = async () => {
    const input = document.getElementById('message-input');
    if (!input.value.trim()) return;
    await addDoc(collection(db, "messages"), {
      user: auth.currentUser.displayName,
      text: input.value,
      room: currentRoom,
      timestamp: serverTimestamp()
    });
    input.value = "";
  };

  // --- ROOM LOGIC (Using Modals) ---
  window.addRoom = (type) => {
    if (type === 'server') {
        openModal("Server Options", "Would you like to create a new server or join an existing one?", "", "Join Existing", () => {
            // This is the Join Flow
            openModal("Join Server", "Paste your invite link or code below:", "Server Code", "Join", (code) => {
                if(code) handleJoinCode(code);
                closeModal();
            });
        });
        // Inject a 'Create' button into the footer for this specific choice
        const footer = document.getElementById('modal-footer');
        const createBtn = document.createElement('button');
        createBtn.className = 'btn-confirm';
        createBtn.style.background = '#23a559';
        createBtn.innerText = "Create New";
        createBtn.onclick = () => {
            openModal("Create Server", "Give your new server a name:", "Server Name", "Create", (name) => {
                if(!name) return;
                const id = name.replace(/\s/g,'') + "-" + Math.random().toString(36).substring(2,7).toUpperCase();
                servers.push({ id, name });
                saveAndRefresh();
                openModal("Server Created", "Share this code: " + id, "", "Close", closeModal, false);
            });
        };
        footer.prepend(createBtn);
    } else {
        openModal("Add Friend", "Enter your friend's username:", "Username", "Add Friend", (f) => {
            if (f) {
                friends.push({ id: f, name: f });
                saveAndRefresh();
                closeModal();
            }
        });
    }
  };

  function handleJoinCode(code) {
    const id = code.includes('=') ? code.split('=')[1] : code;
    const name = id.split('-')[0] || "New Server";
    if (!servers.find(s => s.id === id)) {
        servers.push({ id, name });
        saveAndRefresh();
    }
  }

  function checkInvites() {
    const code = new URLSearchParams(window.location.search).get('join');
    if (code) {
      handleJoinCode(code);
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  window.switchRoom = (id) => {
    currentRoom = id;
    localStorage.setItem('chat_room', id);
    document.getElementById('room-display').innerText = id.split('-')[0];
    renderSidebar();
    initChat();
  };

  window.deleteRoom = (e, id) => {
    e.stopPropagation();
    openModal("Delete", "Remove this from your list?", "", "Remove", () => {
        servers = servers.filter(s => s.id !== id);
        friends = friends.filter(f => f.id !== id);
        if (currentRoom === id) {
            currentRoom = 'Global';
            localStorage.setItem('chat_room', 'Global');
            document.getElementById('room-display').innerText = 'Global';
        }
        saveAndRefresh();
        initChat();
        closeModal();
    }, false);
  };

  function saveAndRefresh() {
    localStorage.setItem('chat_servers', JSON.stringify(servers));
    localStorage.setItem('chat_friends', JSON.stringify(friends));
    renderSidebar();
  }

  function renderSidebar() {
    const sList = document.getElementById('server-list');
    const fList = document.getElementById('friend-list');
    sList.innerHTML = ''; fList.innerHTML = '';
    document.getElementById('item-Global').className = `nav-item global ${currentRoom === 'Global' ? 'active' : ''}`;
    servers.forEach(s => {
        sList.innerHTML += `<div class="nav-item ${currentRoom===s.id?'active':''}" onclick="switchRoom('${s.id}')"># ${s.name} <span class="delete-btn" onclick="deleteRoom(event, '${s.id}')">√ó</span></div>`;
    });
    friends.forEach(f => {
        fList.innerHTML += `<div class="nav-item ${currentRoom===f.id?'active':''}" onclick="switchRoom('${f.id}')">üë§ ${f.name} <span class="delete-btn" onclick="deleteRoom(event, '${f.id}')">√ó</span></div>`;
    });
  }

  window.handleKey = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>
</body>
</html>
